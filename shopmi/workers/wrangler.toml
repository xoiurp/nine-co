# Wrangler Configuration for ShopMi Edge Workers
# Documentation: https://developers.cloudflare.com/workers/wrangler/configuration/

name = "shopmi-edge"
main = "src/index.ts"
compatibility_date = "2024-10-20"
workers_dev = true

# Node.js compatibility
node_compat = false

# Account ID (obtenha em: dash.cloudflare.com -> Workers -> Overview)
account_id = "ad41f4e2927a6daf25f7c7d6891e31bd"

# ============================================
# Environment Variables (não sensíveis)
# ============================================
[vars]
ORIGIN_URL = "http://localhost:3000"  # URL do Next.js local para desenvolvimento
SHOPIFY_DOMAIN = "uxh1te-1d.myshopify.com"
ENVIRONMENT = "development"

# ============================================
# Workers AI Binding
# ============================================
[ai]
binding = "AI"

# ============================================
# KV Namespace for Cache
# ============================================
[[kv_namespaces]]
binding = "CACHE"
id = "8a5f3c63dde44a65b3ef3c5eba6e7fa7"
preview_id = "3e941d6b109445a3a81af6fecaa4fde8"

# ============================================
# D1 Database for Analytics
# ============================================
[[d1_databases]]
binding = "DB"
database_name = "shopmi-analytics"
database_id = "e5c15be8-bfa9-427d-ab81-c2f4c7c47212"

# ============================================
# R2 Bucket for Image Cache (Opcional)
# ============================================
# [[r2_buckets]]
# binding = "IMAGES"
# bucket_name = "shopmi-images"
# preview_bucket_name = "shopmi-images-preview"

# ============================================
# Observability
# ============================================
[observability]
enabled = true

# ============================================
# Development Environment
# ============================================
[env.development]
name = "shopmi-edge-dev"
vars = { ORIGIN_URL = "http://localhost:3000", SHOPIFY_DOMAIN = "uxh1te-1d.myshopify.com", ENVIRONMENT = "development" }

# Herdar bindings do top level
[env.development.ai]
binding = "AI"

[[env.development.kv_namespaces]]
binding = "CACHE"
id = "8a5f3c63dde44a65b3ef3c5eba6e7fa7"
preview_id = "3e941d6b109445a3a81af6fecaa4fde8"

[[env.development.d1_databases]]
binding = "DB"
database_name = "shopmi-analytics"
database_id = "e5c15be8-bfa9-427d-ab81-c2f4c7c47212"

# ============================================
# Staging Environment
# ============================================
[env.staging]
name = "shopmi-edge-staging"
vars = { ORIGIN_URL = "https://mibrasil.com", ENVIRONMENT = "staging" }

# Route para staging (configurar após ter domínio)
# route = { pattern = "staging.suaoja.com/*", zone_name = "suaoja.com" }

# ============================================
# Production Environment
# ============================================
[env.production]
name = "shopmi-edge-production"
vars = { ORIGIN_URL = "https://mibrasil.com", ENVIRONMENT = "production" }

# Route para production (configurar após ter domínio)
# route = { pattern = "suaoja.com/*", zone_name = "suaoja.com" }

# Workers AI em production (se diferente)
# [env.production.ai]
# binding = "AI"

# KV em production
# [[env.production.kv_namespaces]]
# binding = "CACHE"
# id = "SEU_KV_PRODUCTION_ID"

# D1 em production
# [[env.production.d1_databases]]
# binding = "DB"
# database_name = "shopmi-analytics"
# database_id = "SEU_D1_PRODUCTION_ID"

# ============================================
# Build Configuration
# ============================================
# Wrangler compila TypeScript automaticamente, não precisa de build customizado
# [build]
# command = "npm run build"

# ============================================
# Limits & Performance
# ============================================
# limits = { cpu_ms = 50 }  # Timeout em ms (max 50000 para paid plan)

# ============================================
# Secrets (configurar via CLI)
# ============================================
# Execute os comandos abaixo para configurar secrets:
# wrangler secret put CF_IMAGES_TOKEN
# wrangler secret put CF_ACCOUNT_HASH
# wrangler secret put AI_GATEWAY_TOKEN (opcional)

# ============================================
# Tail Consumers (Logging - Opcional)
# ============================================
# [[tail_consumers]]
# service = "shopmi-edge-logger"
